<?xml version="1.0" encoding="utf-8"?>

<!-- This is an XForms+XHTML document for Baseline Tailor, a user interface for tailoring security controls, browsing the Cybersecurity Framework, and creating a Framework Profile. -->

<?xml-stylesheet href="xsltforms/xsltforms.xsl" type="application/xml"?>
<?xsltforms-options debug="no" lang="en_us"?>

<!DOCTYPE html [

<!-- XForms 'appearance' attribute values -->
<!ENTITY ImpactAppearance "minimal">
<!ENTITY FunctionsAppearance "full">
<!ENTITY CategoriesAppearance "minimal">
<!ENTITY FamiliesAppearance "minimal">
<!ENTITY ControlsAppearance "minimal">
<!ENTITY XRefAppearance "minimal">

<!-- Labels for baseline impact widgets -->
<!ENTITY L "LOW">
<!ENTITY M "MODERATE">
<!ENTITY H "HIGH">
<!ENTITY X "N/A">

<!-- Output values for CONTROL BASELINES columns in Security Control Editor -->
<!ENTITY A "Added">
<!ENTITY R "Removed">
<!ENTITY S "Selected">

<!-- Populate baselines checkboxes and control/CE dropdowns -->
<!ENTITY BaselineItemList "
<xf:item>
  <xf:label>&L;</xf:label>
  <xf:value>1</xf:value>
</xf:item>
<xf:item>
  <xf:label>&M;</xf:label>
  <xf:value>2</xf:value>
</xf:item>
<xf:item>
  <xf:label>&H;</xf:label>
   <xf:value>3</xf:value>
</xf:item>
<xf:item>
  <xf:label>&X;</xf:label>
  <xf:value>4</xf:value>
</xf:item>
">

<!-- Populate priorities checkboxes -->
<!ENTITY PriorityItemList "
<xf:item>
  <xf:label>P0</xf:label>
  <xf:value>4</xf:value>
</xf:item>
<xf:item>
  <xf:label>P1</xf:label>
  <xf:value>1</xf:value>
</xf:item>
<xf:item>
  <xf:label>P2</xf:label>
  <xf:value>2</xf:value>
</xf:item>
<xf:item>
  <xf:label>P3</xf:label>
  <xf:value>3</xf:value>
</xf:item>
">

<!-- Actions for subcategory buttons -->
<!ENTITY SubcategoryButtonActions "
<xf:action ev:event='DOMActivate'>
  <xf:setvalue ref='instance(&apos;i-browse&apos;)/crossRef' value='context()'/>
  <xf:setvalue ref='instance(&apos;i-browse&apos;)/crossRef@flag' value='true()'/>
  <xf:setvalue ref='instance(&apos;i-browse&apos;)/function@id' value='substring-before(../../crossRef,&apos;.&apos;)'/>
  <xf:setvalue ref='instance(&apos;i-browse&apos;)/category@id' value='substring-before(../../crossRef,&apos;-&apos;)'/>
  <xf:setvalue ref='instance(&apos;i-browse&apos;)/subcategory@id' value='../../crossRef'>
  </xf:setvalue>
  <xf:dispatch targetid='tab-core' name='DOMActivate'/>
</xf:action>
">

<!-- Trigger controls used within selects for profile1, profile2, etc. -->
<!ENTITY ProfileLabelButton "
<xf:label>
  <xf:trigger ref='.'>
    <xf:label ref='.'/>
      <xf:hint>
      <xf:output ref='.'/>
    </xf:hint>
    &SubcategoryButtonActions;
  </xf:trigger>
</xf:label>
">

<!-- XPath fragments -->
<!ENTITY Root "instance('i-settings')">
<!ENTITY CEXPath "instance('i-settings')/enhancement[number(instance('i-count'))]">
<!ENTITY CXPath "instance('i-settings')/control">
<!ENTITY CEDropDownXPath "enhancement[position()=index('ceDropDown-repeat')]">
<!ENTITY CECatalogXPath "instance('i-catalog')/control[@number=&CXPath;@number]/enhancement">
<!ENTITY SubcatXPath "instance('i-subcats')/id">
<!ENTITY Profile "instance('i-profile')/profile">

<!-- XPath predicate expressions -->
<!ENTITY SubcatPredicate ".=instance('i-browse')/subcategory@id">
<!ENTITY InProfile1 "position() &lt; 13">
<!ENTITY InProfile2 "(position() &gt; 12) and (position() &lt; 25)">
<!ENTITY InProfile3 "(position() &gt; 24) and (position() &lt; 37)">
<!ENTITY InProfile4 "(position() &gt; 36) and (position() &lt; 49)">
<!ENTITY InProfile5 "(position() &gt; 48) and (position() &lt; 61)">
<!ENTITY InProfile6 "(position() &gt; 60) and (position() &lt; 73)">
<!ENTITY InProfile7 "(position() &gt; 72) and (position() &lt; 85)">
<!ENTITY InProfile8 "position() &gt; 84">
<!ENTITY EndOfProfileStringPredicate "ends-with(., instance('i-browse')/subcategory@id)">
<!ENTITY ProfileFlag "boolean-from-string(instance('i-restrict')/profileFlag)">

<!-- string value results for adding/removing profile subcategories -->
<!ENTITY RemoveFromProfile "normalize-space(concat(substring-before(concat(., ' '), instance('i-browse')/subcategory@id), ' ', substring-after(concat(., ' '), instance('i-browse')/subcategory@id)))">
<!ENTITY RemoveFromProfileEnd "normalize-space(substring-before(., instance('i-browse')/subcategory@id))">
<!ENTITY AddToProfile "normalize-space(concat(., ' ', instance('i-browse')/subcategory@id))">

]>

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:html="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events">
  <head>

    <title>Baseline Tailor</title>
    <link rel="shortcut icon" href="images/favicon.ico"/>
    <link rel="stylesheet" href="styles.css" type="text/css"/>

    <xf:model>

      <xf:instance id="i-core" src="bt-model/core.xml" xmlns=""/>
      <xf:instance id="i-cat-dropdown" src="bt-model/cat-dropdown.xml" xmlns=""/>
      <xf:instance id="i-catalog" src="bt-model/catalog.xml" xmlns=""/>
      <xf:instance id="i-families" src="bt-model/families.xml"/>
      <xf:instance id="i-subcats" src="bt-model/subcategories.xml"/>
<!--      <xf:instance id="i-stylesheet" src="bt-model/stylesheet.xsl"/>
      <xf:instance id="i-stylesheet-profile" src="bt-model/stylesheet-profile.xsl"/>-->

      <!-- This model instance helps with determining where to say 'selected', 'added', 'removed' in the UI -->
      <xf:instance id="i-matrix" src="bt-model/matrix.xml"/>

      <xf:instance id="i-pretty-tailored" xmlns="">
	<pretty/>
      </xf:instance>

      <xf:instance id="i-pretty-profile" xmlns="">
	<pretty/>
      </xf:instance>

      <xf:instance id="i-count" xmlns="">
	<count/>
      </xf:instance>

      <xf:instance id="i-xref" xmlns="">
	<xref>AC-1</xref>
      </xf:instance>

      <xf:instance id="i-version" xmlns="">
	<version>0.6</version>
      </xf:instance>

      <xf:instance id="i-updated" xmlns="">
	<updated>2015/11/20</updated>
      </xf:instance>

      <xf:instance id="i-url" xmlns="">
	<controlURL/>
      </xf:instance>

      <xf:instance id="i-core-url" xmlns="">
	<data>
	  <control/>
	  <family/>
	  <all>http://web.nvd.nist.gov/view/800-53/Rev4/home</all>
	</data>
      </xf:instance>


      <xf:instance id="i-ceTemplate" xmlns="">
	<data>
	  <xRefLabel/>
	  <impact label="" value=""/> 
	  <gFlag>false</gFlag>
	  <l/>
	  <m/>
	  <h/>
	  <guidance>Guidance here.</guidance>
	</data>
      </xf:instance>

      <xf:instance id="i-baselines" xmlns="">
	<data>
	  <baselines>1 2 3</baselines>
	</data>
      </xf:instance>

      <xf:instance id="i-priorities" xmlns="">
	<data>
	  <priorities>1 2 3</priorities>
	</data>
      </xf:instance>

      <xf:instance id="i-restrict" xmlns="">
	<data>
	  <profileFlag>false</profileFlag>
	</data>
      </xf:instance>

      <xf:instance id="i-choices" xmlns="">
	<data>
	  <impact label="&L;" value="1"/>
	  <impact label="&M;" value="2"/>
	  <impact label="&H;" value="3"/>
	  <impact label="&X;" value="4"/>
	</data>
      </xf:instance>

      <xf:instance id="i-alerts" xmlns="">
	<data>
	  <cImpactTooHigh>Control impact higher than lowest control enhancement impact.</cImpactTooHigh>
	  <ceImpactTooLow>Control Enhancement impact lower than control impact.</ceImpactTooLow>
	  <CM-7>CM-7(4) impact as high or higher than CM-7(5) impact. Blacklisting and whitelisting cannot be applied simultaneously, and whitelisting is more restrictive than blacklisting.</CM-7>
	  <illegalGuidance>Control Enhancement must have LOW, MODERATE, or HIGH impact if adding supplemental guidance.</illegalGuidance>
	  <illegalXRef>Cross-reference to Control Enhancement without added supplemental guidance.</illegalXRef>
	</data>
      </xf:instance>

      <!-- This model instance captures the current Framework Core browser UI state. -->
      <xf:instance id="i-browse" xmlns="">
	<data>
	  <function id="ID"/>
	  <category id="ID.AM">
	    <description/>
	  </category>
	  <subcategory id="ID.AM-1" addText="Add to Profile" removeText="Remove from Profile">
	    <description/>
	    <sp800-53-all-message flag="false">Controls from all families</sp800-53-all-message>
	  </subcategory>
	  <crossRef flag="false"/>
	</data>
      </xf:instance>

      <xf:instance id="i-profile">
	<data xmlns="">
          <profile1/>
          <profile2/>
          <profile3/>
          <profile4/>
          <profile5/>
          <profile6/>
          <profile7/>
          <profile8/>
          <profile/>
	</data>
      </xf:instance>

      <!-- This model instance captures the current tailoring UI state. The 'control' and 'enhancement' elements have dynamic content representing the  current state of the control and control enhancement information. -->
      <xf:instance id="i-settings" xmlns="">
	<tailoredControl>
	  <family>ACCESS CONTROL</family>
	  <rationale flag="false">Rationale here.</rationale>
	  <control number="AC-1">
	    <title>ACCESS CONTROL POLICY AND PROCEDURES</title>
	    <default>1</default>
	    <impact label="&L;" value="1"/>
	    <gFlag>false</gFlag>
	    <l>&S;</l>
	    <m>&S;</m>
	    <h>&S;</h>
	    <guidance>Guidance here.</guidance>
	  </control>
	</tailoredControl>
      </xf:instance>

      <xf:bind nodeset="&Profile;" calculate="concat(../profile1, ' ', ../profile2, ' ', ../profile3, ' ', ../profile4,' ', ../profile5, ' ', ../profile6, ' ',../profile7, ' ', ../profile8)"/>

      <xf:bind nodeset="instance('i-browse')/category/description" calculate="instance('i-core')//description[..@id=instance('i-browse')/category@id]"/>

      <xf:bind nodeset="instance('i-browse')/subcategory/description" calculate="instance('i-core')//description[..@id=instance('i-browse')/subcategory@id]"/>

      <xf:bind nodeset="instance('i-browse')//sp800-53-all-message@flag" calculate="choose(instance('i-core')//sp800-53[@all=true() and ..@id=instance('i-browse')/subcategory@id], true(), false())" type="xs:boolean"/>

      <xf:bind nodeset="instance('i-browse')//sp800-53-all-message" relevant="@flag=true()"/>

      <xf:bind nodeset="instance('i-browse')/crossRef@flag" calculate="choose(not(substring-before(..,'.')=../../function@id and substring-before(..,'-')=../../category@id and ..=../../subcategory@id), false(), .)" type="xs:boolean"/>

      <xf:bind nodeset="instance('i-browse')/subcategory@removeText" relevant="contains(&Profile;, concat(..@id, ' ')) or ends-with(&Profile;, ..@id)"/>

      <xf:bind nodeset="instance('i-browse')/subcategory@addText" relevant="not(contains(&Profile;, concat(..@id, ' ')) or ends-with(&Profile;, ..@id))"/>

<!--      <xf:bind nodeset="instance('i-browse')/category@id" calculate="substring-before(instance('i-browse')/subcategory@id, '-')"/>

      <xf:bind nodeset="instance('i-browse')/function@id" calculate="substring-before(instance('i-browse')/category@id, '.')"/>-->

      <xf:bind nodeset="instance('i-url')" calculate="concat('http://web.nvd.nist.gov/view/800-53/Rev4/control?controlName=', instance('i-settings')/control@number)"/>

      <xf:bind nodeset="instance('i-settings')/enhancement/xRefLabel" calculate="concat('(',..@number,')')"/>

      <!-- Constraints to warn if control and CE impacts inconsistent -->
      <xf:bind nodeset="&CXPath;/impact@value" constraint=". &lt;= choose(&Root;/enhancement, min(&Root;/enhancement/impact@value), '4')"/>
      <xf:bind nodeset="instance('i-settings')/enhancement/impact@value" constraint=". &gt;= &CXPath;/impact@value"/>

      <!-- CM-7 blacklisting/whitelisting constraints -->
      <xf:bind nodeset="instance('i-settings')/enhancement[../control@number = 'CM-7' and @number = '4']/impact@value" constraint=". &gt;= &CXPath;/impact@value and (. = '4' or &Root;/enhancement[@number='5']/impact@value = '4' or . &lt; &Root;/enhancement[@number='5']/impact@value)"/>
      <xf:bind nodeset="instance('i-settings')/enhancement[../control@number = 'CM-7' and @number = '5']/impact@value" constraint=". &gt;= &CXPath;/impact@value and (. = '4' or &Root;/enhancement[@number='4']/impact@value = '4' or . &gt; &Root;/enhancement[@number='4']/impact@value)"/>

      <xf:bind nodeset="instance('i-settings')/rationale@flag" type="xs:boolean" calculate="&CXPath;[default!=impact@value] or instance('i-settings')/enhancement[default!=impact@value]"/>

      <xf:bind id="b-c-gFlag" nodeset="&CXPath;/gFlag" type="xs:boolean"/>

      <xf:bind nodeset="instance('i-settings')/enhancement/gFlag" constraint="(. = false() or ../impact@value &lt; '4') and ((. &lt; '1' or . &gt; '25') or instance('i-settings')/enhancement[@number=current()]/gFlag = true())"/>

      <xf:bind nodeset="instance('i-settings')//guidance"
	       relevant="..[gFlag=true()]"/>

      <xf:bind nodeset="instance('i-settings')/rationale" relevant= "@flag=true()"/>

      <xf:bind nodeset="instance('i-pretty-tailored')" calculate="transform(instance('i-settings'), 'bt-model/stylesheet.xsl', false())"/>

      <xf:bind nodeset="instance('i-pretty-profile')" calculate="transform(&Profile;, 'bt-model/stylesheet-profile.xsl', false())"/>

      <xf:bind nodeset="instance('i-restrict')/profileFlag" type="xs:boolean"/>

    </xf:model>

  </head>
  <body>

    <h1><img alt="needle and thread image" width="50px" height="50px" src="images/Needle_and_thread_silhouette.png"/><span class="SWTitle">Baseline Tailor</span> <span class="SWSubTitle">Version <xf:output ref="instance('i-version')"/></span></h1>

    <div id="horizontal-tab-menu">
      <xf:trigger id="tab-tailor" appearance="minimal">
	<xf:label class="TabText">Security Control Editor</xf:label>
	<xf:toggle case="case-tailor" ev:event="DOMActivate"/>
      </xf:trigger>
      <xf:trigger id="tab-core" appearance="minimal">
	<xf:label class="TabText">Cyber Framework Browser</xf:label>
	<xf:toggle case="case-core" ev:event="DOMActivate"/>
      </xf:trigger>
      <xf:trigger id="tab-profile" appearance="minimal">
	<xf:label class="TabText">Framework Profile</xf:label>
	<xf:toggle case="case-profile" ev:event="DOMActivate"/>
      </xf:trigger>
      <xf:trigger id="tab-xref" appearance="minimal">
	<xf:label class="TabText">Cross References</xf:label>
	<xf:toggle case="case-xref" ev:event="DOMActivate"/>
      </xf:trigger>
    </div>

    <xf:switch>
      <xf:case id="case-core" selected="false">
	<div id="div-core">
	  <xf:group ref="instance('i-browse')">
	    <table>
	      <tr class="Row">
		<td class="Cell">
		  <div class="Functions">
		    <xf:select1 appearance="&FunctionsAppearance;" ref="function@id">
		      <xf:label>Framework core function:<br/></xf:label>
		      <xf:item>
			<xf:label class="ID">IDENTIFY (ID)</xf:label>
			<xf:value>ID</xf:value>
		      </xf:item>
		      <xf:item>
			<xf:label class="PR">PROTECT (PR)</xf:label>
			<xf:value>PR</xf:value>
		      </xf:item>
		      <xf:item>
			<xf:label class="DE">DETECT (DE)</xf:label>
			<xf:value>DE</xf:value>
		      </xf:item>
		      <xf:item>
			<xf:label class="RS">RESPOND (RS)</xf:label>
			<xf:value>RS</xf:value>
		      </xf:item>
		      <xf:item>
			<xf:label class="RC">RECOVER (RC)</xf:label>
			<xf:value>RC</xf:value>
		      </xf:item>
		      <xf:action ev:event="xforms-value-changed" if="instance('i-browse')/crossRef@flag=false()">
			<xf:setvalue ref="instance('i-browse')/category@id" value="instance('i-core')//category@id[../..@id=instance('i-browse')/function@id]"/>
			<xf:setvalue ref="instance('i-browse')/category/description" value="instance('i-core')//category/description[..@id=instance('i-browse')/category@id]"/>
		      </xf:action>
		    </xf:select1>
		  </div>
		</td>
		<td>
		  <table>
		    <tr>
		      <td class="Cell">
		      <xf:select1 ref="category@id" appearance="&CategoriesAppearance;">
			<xf:label>Category:<br/></xf:label>
			<xf:itemset nodeset="instance('i-cat-dropdown')//cat[substring-before(id, '.')=instance('i-browse')/function@id]">
			  <xf:label ref="label"/> 
			  <xf:value ref="id"/>
			</xf:itemset>
			<xf:action ev:event="xforms-value-changed" if="instance('i-browse')/crossRef@flag=false()">
			  <xf:setvalue ref="instance('i-browse')/subcategory@id" value="instance('i-core')//subCategory@id[../..@id=instance('i-browse')/category@id]"/>
			</xf:action>
			</xf:select1><br/>
			<strong>
			  <xf:output ref="category@id"/>
			  <span>: </span>
			</strong>
			<xf:output ref="category/description"/>
		      </td>
		    </tr>
		    <tr>
		      <td class="Cell">
			<xf:group ref="subcategory">
			  <xf:select1 appearance="&CategoriesAppearance;" ref="@id">
			  <xf:label>Subcategory:<br/></xf:label>
			  <xf:itemset nodeset=
"instance('i-core')//subCategory[..@id=instance('i-browse')/category@id]">
			    <xf:label ref="@id"/>
			    <xf:value ref="@id"/>
			  </xf:itemset>
			  </xf:select1><br/>
			  <strong>
			    <xf:output ref="@id"/>
			    <span>: </span>
			  </strong>
			  <xf:output ref="description"/><br/>
			  <xf:trigger ref="@removeText">
			    <xf:label ref="."/>
			    <xf:hint>
			      <span>Remove subcategory </span>
			      <xf:output ref="..@id"/>
			      <span> from the Framework Profile.</span>
			    </xf:hint>
			    <xf:action ev:event="DOMActivate">
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and (&InProfile1;)]" ref="&Profile;1" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile2;]" ref="&Profile;2" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile3;]" ref="&Profile;3" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile4;]" ref="&Profile;4" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile5;]" ref="&Profile;5" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile6;]" ref="&Profile;6" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile7;]" ref="&Profile;7" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and (&InProfile8;)]" ref="&Profile;8" value="choose(&EndOfProfileStringPredicate;, &RemoveFromProfileEnd;, &RemoveFromProfile;)"/>
<!--			      <xf:dispatch targetid="tab-profile" name="DOMActivate"/>-->
			    </xf:action>
			  </xf:trigger>
			  <xf:trigger ref="@addText">
			    <xf:label ref="."/>
			    <xf:hint>
			      <span>Add subcategory </span>
			      <xf:output ref="..@id"/>
			      <span> to the Framework Profile.</span>
			    </xf:hint>
			    <xf:action ev:event="DOMActivate">
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and (&InProfile1;)]" ref="&Profile;1" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile2;]" ref="&Profile;2" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile3;]" ref="&Profile;3" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile4;]" ref="&Profile;4" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile5;]" ref="&Profile;5" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile6;]" ref="&Profile;6" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and &InProfile7;]" ref="&Profile;7" value="&AddToProfile;"/>
			      <xf:setvalue if="&SubcatXPath;[&SubcatPredicate; and (&InProfile8;)]" ref="&Profile;8" value="&AddToProfile;"/>
<!--			      <xf:dispatch targetid="tab-profile" name="DOMActivate"/>-->
			    </xf:action>
			  </xf:trigger>
			</xf:group>
		      </td>
		    </tr>
		  </table>
		</td>
	      </tr>
	    </table>
	    <p>Informative References to NIST SP 800-53:</p>
	    <xf:repeat nodeset="instance('i-core')//subCategory[@id=instance('i-browse')/subcategory@id]/sp800-53/family">
	      <xf:trigger>
		<xf:label>
		  <xf:output ref="."/>
		  <span> family</span>
		</xf:label>
		<xf:hint>
		  <span>Open security control family </span>
		  <xf:output ref="."/>
		  <span> in a new browser tab.</span>
		</xf:hint>
		<xf:action ev:event="DOMActivate">
		  <xf:setvalue ref="instance('i-core-url')/family" value="concat('http://web.nvd.nist.gov/view/800-53/Rev4/family?familyName=', instance('i-families')/family@name[starts-with(../control@number, context())])"/>
		  <xf:load show="new" ref="instance('i-core-url')/family"/>
		</xf:action>
	      </xf:trigger>
	    </xf:repeat>
	    <xf:repeat nodeset="instance('i-core')//subCategory[@id=instance('i-browse')/subcategory@id]/sp800-53/control">
	      <table>
		<tr>
		  <td class="ControlButton">
		    <xf:trigger>
		      <xf:label ref="."/>
		      <xf:hint>
			<span>Open security control </span>
			<xf:output ref="."/>
			<span> definition in a new browser tab.</span>
		      </xf:hint>
		      <xf:action ev:event="DOMActivate">
			<xf:setvalue ref="instance('i-core-url')/control" value="concat('http://web.nvd.nist.gov/view/800-53/Rev4/control?controlName=', context())"/>
			<xf:load show="new" ref="instance('i-core-url')/control"/>
		      </xf:action>
		    </xf:trigger>
		  </td>
		  <td class="ControlButton">
		    <xf:trigger>
		      <xf:label>
			<img src="images/favicon.ico" alt="needle and thread image"/>
		      </xf:label>
		      <xf:hint>
			<span>Tailor security control </span>
			<xf:output ref="context()"/>
			<span>.</span>
		      </xf:hint>
		      <xf:action ev:event="DOMActivate">
			<xf:setvalue ref="instance('i-settings')/family" value="instance('i-families')/family@name[starts-with(../control@number, substring-before(context(), '-'))]"/>
			<xf:setvalue ref="instance('i-settings')/control@number" value="context()"/>
			<xf:dispatch targetid="tab-tailor" name="DOMActivate"/>
		      </xf:action>
		    </xf:trigger>
		  </td>
		  <td class="ControlButton">
		    <xf:trigger>
		      <xf:label>xref</xf:label>
		      <xf:hint>
			<span>Show Framework Core subcategories referencing </span>
			<xf:output ref="context()"/>
			<span>.</span>
		      </xf:hint>
		      <xf:action ev:event="DOMActivate">
			<xf:setvalue ref="instance('i-xref')" value="context()"/>
			<xf:dispatch targetid="tab-xref" name="DOMActivate"/>
		      </xf:action>
		    </xf:trigger>
		  </td>
		</tr>
	      </table>
	    </xf:repeat>
	    <xf:group ref="subcategory/sp800-53-all-message">
	      <xf:trigger>
		<xf:label ref="."/>
		<xf:hint>Open security control catalog in a new browser tab.</xf:hint>
		<xf:load ev:event="DOMActivate" show="new" ref="instance('i-core-url')/all"/>
	      </xf:trigger>
	      <xf:repeat nodeset="instance('i-core')//subCategory[@id=instance('i-browse')/subcategory@id]/sp800-53/except">
		<span>(except </span>
		<xf:output ref="."/>
		<span>)</span>
	      </xf:repeat>
	    </xf:group>
	  </xf:group>
	</div>
      </xf:case>

      <xf:case id="case-profile" selected="false">
	<div id="div-profile">
	  <xf:group ref="instance('i-profile')">
	    <xf:label>Check/uncheck the subcategory box to add to or remove the subcategory from the profile. Click the subcategory button to show its Framework Core information.</xf:label>
	    <table>
	      <tr class="Row">
		<td class="Cell">
		  <xf:select ref="profile1" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile1;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile2" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile2;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile3" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile3;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile4" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile4;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile5" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile5;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile6" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile6;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile7" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile7;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
		<td class="Cell">
		  <xf:select ref="profile8" appearance="full">
		    <xf:label/>
		    <xf:itemset nodeset="&SubcatXPath;[&InProfile8;]">
		      &ProfileLabelButton;
                      <xf:value ref="." />
                    </xf:itemset>
                  </xf:select>
		</td>
	      </tr>
	    </table>
	    <xf:group>
	      <xf:label>XML representation:</xf:label>
	      <xf:textarea class="XMLData" ref="instance('i-pretty-profile')">
		<xf:label/>
	      </xf:textarea>
	    </xf:group>
	  </xf:group>
	</div>
      </xf:case>
      
      <xf:case id="case-tailor" selected="true">
	<div id="div-tailor">
	  <xf:group ref="instance('i-settings')">

	    <table>
	      <tr class="Row">
		<td class="WideCell">
		  <xf:group ref="instance('i-baselines')/baselines">
		    <xf:label>Baselines:</xf:label>
		    <xf:select appearance="full" ref=".">
		      &BaselineItemList;
		    </xf:select>
		    <xf:trigger>
		      <xf:label>Defaults</xf:label>
		      <xf:hint>Check LOW, MODERATE, and HIGH boxes.</xf:hint>
		      <xf:reset ev:event="DOMActivate"/>
		    </xf:trigger>
		  </xf:group>
		</td>
		<td class="WideCell">
		  <xf:group ref="instance('i-priorities')/priorities">
		    <xf:label>Priorities:</xf:label>
		    <xf:select appearance="full" ref=".">
		      &PriorityItemList;
		    </xf:select>
		    <xf:trigger>
		      <xf:label>Defaults</xf:label>
		      <xf:hint>Check P1, P2, and P3 boxes.</xf:hint>
		      <xf:reset ev:event="DOMActivate"/>
		    </xf:trigger>
		  </xf:group>
		</td>
		<td class="WideCell">
		  <xf:input ref="instance('i-restrict')/profileFlag" appearance="full">
		    <xf:label>Restrict controls to Framework Profile informative references: </xf:label>
		  </xf:input><br/><br/>

		  <xf:select1 appearance="&FamiliesAppearance;" ref="family">
		    <xf:label>Control family:<br/></xf:label>
		    <xf:itemset nodeset="choose(&ProfileFlag;, instance('i-families')/family[control/subcategory[contains(&Profile;, concat(@number, ' ')) or ends-with(&Profile;, @number)]], instance('i-families')/family)">
		      <xf:label ref="@name"/>
		      <xf:value ref="@name"/>
		    </xf:itemset>
		  </xf:select1>
		  <br/><br/>

		  <xf:select1 appearance="&ControlsAppearance;" ref="control@number">
		    <xf:label>Control:<br/></xf:label>
		    <xf:itemset nodeset="instance('i-families')/family[@name=instance('i-settings')/family]/control[contains(instance('i-baselines')/baselines,default) and contains(instance('i-priorities')/priorities,priority) and (not(&ProfileFlag;) or subcategory[contains(&Profile;, concat(@number, ' ')) or ends-with(&Profile;, @number)])]">
		      <xf:label ref="instance('i-families')/family[@name=instance('i-settings')/family]//dropDownLabel[..@number=context()/@number]"/>
		      <xf:value ref="@number"/>
		    </xf:itemset>
		    <xf:action ev:event="xforms-value-changed">

		      <!-- update control info in the UI -->
		      <xf:setvalue ref="../title" value="instance('i-catalog')/control[@number=&CXPath;@number]/title"/>
		      <xf:setvalue ref="../default" value="instance('i-catalog')/control[@number=&CXPath;@number]/default"/>
		      <xf:setvalue ref="../impact@label" value="instance('i-choices')/impact[@value=&CXPath;/default]@label"/>
		      <xf:setvalue ref="../impact@value" value="instance('i-choices')/impact[@value=&CXPath;/default]@value"/>
		      <xf:setvalue ref="../gFlag" value="false()"/>
		      <xf:setvalue ref="../l" value="instance('i-matrix')/row[@value=concat(&CXPath;/default,&CXPath;/impact@value)]/l"/>
		      <xf:setvalue ref="../m" value="instance('i-matrix')/row[@value=concat(&CXPath;/default,&CXPath;/impact@value)]/m"/>
		      <xf:setvalue ref="../h" value="instance('i-matrix')/row[@value=concat(&CXPath;/default,&CXPath;/impact@value)]/h"/>

		      <!-- replace control enhancement data as per new selection -->
		      <xf:delete nodeset="instance('i-settings')//enhancement"/>
		      <xf:insert nodeset="instance('i-settings')/*" origin="&CECatalogXPath;" at="last()" if="&CECatalogXPath;"/>
		      <xf:setvalue ref="instance('i-count')" value="0"/>

		      <xf:action while="instance('i-count') &lt; count(instance('i-settings')/enhancement)">
			<xf:setvalue ref="instance('i-count')" value="instance('i-count') + 1"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/xRefLabel" context="&CEXPath;/default"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/impact" context="&CEXPath;/xRefLabel"/>
			<xf:setvalue ref="&CEXPath;/impact@label" value="instance('i-choices')/impact[@value=&CEXPath;/default]@label"/>
			<xf:setvalue  ref="&CEXPath;/impact@value" value="../../default"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/gFlag" context="&CEXPath;/impact"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/guidance" context="&CEXPath;/gFlag"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/l" context="&CEXPath;/guidance"/>
			<xf:setvalue ref="&CEXPath;/l" value="instance('i-matrix')/row[@value=concat(&CEXPath;/default,&CEXPath;/impact@value)]/l"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/m" context="&CEXPath;/l"/>
			<xf:setvalue ref="&CEXPath;/m" value="instance('i-matrix')/row[@value=concat(&CEXPath;/default,&CEXPath;/impact@value)]/m"/>
			<xf:insert nodeset="&CEXPath;/*" origin="instance('i-ceTemplate')/h" context="&CEXPath;/m"/>
			<xf:setvalue ref="&CEXPath;/h" value="instance('i-matrix')/row[@value=concat(&CEXPath;/default,&CEXPath;/impact@value)]/h"/>
		      </xf:action>

		    </xf:action>
		  </xf:select1>
		  <br/><br/>
		  <xf:trigger>
		    <xf:label>
		      <span>Framework Core Subcategories Referencing </span>
		      <xf:output ref="instance('i-settings')/control@number"/>
		    </xf:label>
		    <xf:hint>
		      <span>Show Framework Core subcategories referencing </span>
		      <xf:output ref="instance('i-settings')/control@number"/>
		      <span>.</span>
		    </xf:hint>
		    <xf:action ev:event="DOMActivate">
		      <xf:setvalue ref="instance('i-xref')" value="instance('i-settings')/control@number"/>
		      <xf:dispatch targetid="tab-xref" name="DOMActivate"/>
		    </xf:action>
		  </xf:trigger>
		</td>
	      </tr>
	    </table>
	  </xf:group>
	  <p/>
      
	  <table border="1">

	    <!-- Security control header -->
	    <tr class="Heading">
	      <td rowspan="2">CONTROL<br/>NUMBER</td>
	      <td rowspan="2">CONTROL NAME<br/><div class="CETitle">Control Enhancement Name</div></td>
	      <td rowspan="2">BASELINE<br/>IMPACT</td>
	      <td rowspan="2">ADDED<br/>SUPPLE-<br/>MENTAL<br/>GUIDANCE</td>
	      <td colspan="3">CONTROL BASELINES</td>
	    </tr>
	    <tr class="Heading">
	      <td>LOW</td>
	      <td>MODERATE</td>
	      <td>HIGH</td>
	    </tr>
      
	    <tr class="Row">
	
	      <!-- Cell containing control and control enhancement IDs -->
	      <td>
		<div class="Cell">
		  <xf:trigger>
		    <xf:label ref="&CXPath;@number"/>
		    <xf:hint>
		      <span>Open security control </span>
		      <xf:output ref="&CXPath;@number"/>
		      <span> definition in a new browser tab.</span>
		    </xf:hint>
		    <xf:load ev:event="DOMActivate" show="new" ref="instance('i-url')"/>
		  </xf:trigger>
		</div>
		<xf:repeat nodeset="instance('i-settings')/enhancement">
		  <div class="Cell">
		    <xf:output ref="&CXPath;@number"/>
		    <span>(</span>
		    <xf:output ref="@number"/>
		    <span>)</span>
		  </div>
		</xf:repeat>
	      </td>
	
	      <!-- Cell containing control and control enhancement names. Control name links to NIST NVD documentation. -->
	      <td>
		<div class="Cell">
		  <span class="Control">
		    <xf:output ref="&CXPath;/title"/>
		    <xf:output value="' '"/>
		  </span>
		</div>
		<xf:repeat nodeset="instance('i-settings')/enhancement">
		  <div class="Cell"><span class="CETitle">
		    <xf:output ref="title"/>
		  </span></div>
		</xf:repeat>
	      </td>
	
	      <!-- Cell containing drop-down lists for selecting impacts -->
	      <td>
	  
		<!-- Drop-down for selecting control impact-->
		<div class="DropDownCell">
		  <xf:select1 appearance="&ImpactAppearance;" ref="&CXPath;/impact@value">
		    <xf:label/>&BaselineItemList;
		    <xf:alert>
		      <xf:output ref="instance('i-alerts')/cImpactTooHigh"/>
		    </xf:alert>
		    <xf:action ev:event="xforms-value-changed">
		      <xf:setvalue ref="..@label" value="instance('i-choices')/impact[@value=&CXPath;/impact@value]@label"/>
		      <xf:setvalue ref="../../l" value="instance('i-matrix')/row[@value=concat(&CXPath;/default,&CXPath;/impact@value)]/l"/>
		      <xf:setvalue ref="../../m" value="instance('i-matrix')/row[@value=concat(&CXPath;/default,&CXPath;/impact@value)]/m"/>
		      <xf:setvalue ref="../../h" value="instance('i-matrix')/row[@value=concat(&CXPath;/default,&CXPath;/impact@value)]/h"/>
		    </xf:action>
		  </xf:select1>
		</div>

		<!-- Drop-downs for selecting control enhancement impacts -->
		<xf:repeat id="ceDropDown-repeat" nodeset="instance('i-settings')/enhancement">
		  <div class="DropDownCell">
		    <xf:select1 appearance="&ImpactAppearance;" ref="impact@value">
		      <xf:label/>&BaselineItemList;
		      <xf:alert>
			<xf:output value="choose(&Root;/control[@number='CM-7'] and &Root;/enhancement[@number='4']/impact/@value != '4' and &Root;/enhancement[@number='5']/impact/@value != '4' and &Root;/enhancement[@number='4']/impact/@value &gt;= &Root;/enhancement[@number='5']/impact/@value, instance('i-alerts')/CM-7, instance('i-alerts')/ceImpactTooLow)"/>
		      </xf:alert>

		      <xf:action ev:event="xforms-value-changed">
			<xf:setvalue ref="..@label" value="instance('i-choices')/impact[@value=instance('i-settings')/&CEDropDownXPath;/impact@value]@label"/>
			<xf:setvalue ref="../../l" value="instance('i-matrix')/row[@value=concat(instance('i-settings')/&CEDropDownXPath;/default,instance('i-settings')/&CEDropDownXPath;/impact@value)]/l"/>
			<xf:setvalue ref="../../m" value="instance('i-matrix')/row[@value=concat(instance('i-settings')/&CEDropDownXPath;/default,instance('i-settings')/&CEDropDownXPath;/impact@value)]/m"/>
			<xf:setvalue ref="../../h" value="instance('i-matrix')/row[@value=concat(instance('i-settings')/&CEDropDownXPath;/default,instance('i-settings')/&CEDropDownXPath;/impact@value)]/h"/>
		      </xf:action>
		    </xf:select1>
		  </div>
		</xf:repeat>

	      </td>

	      <!-- Cell containing checkboxes for added supplemental guidance -->
	      <td>
		<div class="DropDownCell">
		  <xf:input incremental="true" bind="b-c-gFlag">
		    <xf:label/>
		  </xf:input>
		</div>
		<xf:repeat nodeset="instance('i-settings')/enhancement/gFlag">
		  <div class="DropDownCell">
		    <xf:select1 ref="." appearance="&XRefAppearance;">
		      <xf:label/>
		      <xf:item>
			<xf:label>NO</xf:label>
			<xf:value>false</xf:value>
		      </xf:item>
		      <xf:item>
			<xf:label>YES</xf:label>
			<xf:value>true</xf:value>
		      </xf:item>
		      <xf:itemset nodeset="instance('i-settings')/enhancement">
			<xf:label ref="xRefLabel"/>
			<xf:value ref="@number"/>
		      </xf:itemset>
		      <xf:alert>
			<xf:output value="choose(not(. = false()) and ../impact@value = '4', instance('i-alerts')/illegalGuidance, instance('i-alerts')/illegalXRef)"/>
		      </xf:alert>
		    </xf:select1>
		  </div>
		</xf:repeat>
	      </td>
	
	      <!-- Cells containing info on baseline selections, additions, removals -->
	      <td>
		<div class="Cell">
		  <xf:output ref="&CXPath;/l"/>
		</div>
		<xf:repeat nodeset="instance('i-settings')/enhancement">
		  <div class="Cell">
		    <xf:output ref="l"/>
		  </div>
		</xf:repeat>
	      </td>
	      <td>
		<div class="Cell">
		  <xf:output ref="&CXPath;/m"/>
		</div>
		<xf:repeat nodeset="instance('i-settings')/enhancement">
		  <div class="Cell">
		    <xf:output ref="m"/>
		  </div>
		</xf:repeat>
	      </td>
	      <td>
		<div class="Cell">
		  <xf:output ref="&CXPath;/h"/>
		</div>
		<xf:repeat nodeset="instance('i-settings')/enhancement">
		  <div class="Cell">
		    <xf:output ref="h"/>
		  </div>
		</xf:repeat>
	      </td>
	    </tr>
	    <tr class="Row">
	      <td colspan="2" class="Cell">
		<xf:group>
		  <xf:label>XML representation:</xf:label>
		  <xf:textarea class="XMLData" ref="instance('i-pretty-tailored')">
		    <xf:label/>
		  </xf:textarea>
		</xf:group>
	      </td>
	      <td colspan="5" class="Cell">
		
		<div>
		  <xf:textarea class="Guidance" incremental="true" ref="&CXPath;/guidance">
		    <xf:label>Additional Supplemental Guidance:<br/></xf:label>
		  </xf:textarea>
		</div>

		<xf:repeat nodeset="instance('i-settings')/enhancement/guidance">
		  <div>
		    <xf:group>
		      <xf:label>
			<span>Control Enhancement (</span>
			<xf:output ref="..@number"/>
			<span>) Additional Supplemental Guidance:</span><br/>
		      </xf:label>
		      <xf:textarea ref="." class="Guidance" incremental="true">
			<xf:label/>
		      </xf:textarea>
		    </xf:group>
		  </div>
		</xf:repeat>
	  
		<div>
		  <xf:textarea class="Guidance" incremental="true" ref="instance('i-settings')/rationale">
		    <xf:label>Rationale for changing the baseline:<br/></xf:label>
		  </xf:textarea>
		</div>
		
	      </td>
	    </tr>
	  </table>
	</div>
      </xf:case>    

      <xf:case id ="case-xref" selected="false">
	<div id="div-xref">
	  <xf:group class="Cell">
	    <span>Framework Core subcategories referencing control </span>
	    <xf:output ref="instance('i-xref')"/>
	    <span>:</span><br/>
<!--	    <xf:repeat nodeset="instance('i-core')//subCategory[sp800-53/control=instance('i-settings')/control@number or sp800-53/family=substring-before(instance('i-settings')/control@number, '-') or (sp800-53@all and not(sp800-53/except=instance('i-settings')/control@number))]@id">
	    <xf:repeat nodeset="instance('i-families')//subcategory@number[../..@number=instance('i-settings')/control@number]"> -->
	    <xf:repeat nodeset="instance('i-families')//subcategory@number[../..@number=instance('i-xref')]">
	      <xf:trigger>
		<xf:label ref="."/>
		<xf:hint>
		  <span>Show Framework Core </span>
		  <xf:output ref="."/>
		  <span> definition.</span>
		</xf:hint>
		&SubcategoryButtonActions;
	      </xf:trigger>
	    </xf:repeat>
	  </xf:group>
	</div>
      </xf:case>
    </xf:switch>

    <div class="footer">
      <p>
	
Last updated: <xf:output ref="instance('i-updated')"/>

<br/>

Contact: <strong><a href="mailto:lubell@nist.gov">Joshua
Lubell</a></strong>

      </p>
    </div>
    
  </body>
  
</html>
